# Local Execution with Docker Compose

The flowctl tool supports local execution of pipelines using Docker Compose. This document describes how to use this feature.

## Overview

Local execution allows you to run your pipeline components on your local machine using Docker Compose. This is useful for development and testing purposes. The local execution generator creates a Docker Compose configuration file with profiles, making it easy to start and stop specific components.

## Docker Compose Profiles

The local execution generator uses Docker Compose profiles to organize components. All components are tagged with the `local` profile, which means they will only be started when the `local` profile is activated.

## Usage

To generate a Docker Compose configuration for local execution:

```bash
flowctl translate -f my-pipeline.yaml -o docker-compose.yaml -t local
```

This will create:
1. A Docker Compose configuration file (`docker-compose.yaml`)
2. An environment file (`.env.<pipeline-name>`)

To start the pipeline:

```bash
docker compose --profile local up -d
```

To view logs:

```bash
docker compose logs -f
```

To stop the pipeline:

```bash
docker compose down
```

## Configuration

The local execution mode supports the following configuration options:

### Environment Variables

- `FLOWCTL_LOCAL_GENERATOR_TYPE`: Specifies the local generator type to use. 
  - `docker` (default): Uses Docker Compose profiles
  - `bash`: Uses the legacy bash script generator

### Volume Management

The generated Docker Compose configuration includes two named volumes:

- `local-data`: A shared volume for persistent data across components
- `local-logs`: A volume for component logs

### Network Configuration

All components are connected to a common network (`local-network`), allowing them to communicate with each other.

### Health Checks

Health checks are automatically configured for components that specify a `health_check` endpoint. This ensures that dependent components only start when their prerequisites are healthy.

## Example

Here's an example of a generated Docker Compose configuration:

```yaml
# Docker Compose configuration for local execution
# Generated by flowctl
#
# Pipeline: my-pipeline
#
# Usage:
# - Start all components: docker compose --profile local up -d
# - View logs: docker compose logs -f
# - Stop all components: docker compose down
#
# Logs directory: logs/my-pipeline
# Environment file: .env.my-pipeline
#
version: "3.8"
services:
  source_component:
    image: source-image:latest
    container_name: local-my-pipeline-source_component
    restart: unless-stopped
    environment:
      FLOW_COMPONENT_ID: source-component
      FLOW_COMPONENT_TYPE: source
      FLOW_PIPELINE_NAME: my-pipeline
      FLOW_LOG_FILE: /var/log/flowctl/my-pipeline/source_component.log
    volumes:
      - local-logs:/var/log/flowctl/my-pipeline
      - local-data:/flow/data
    networks:
      - local-network
    profiles:
      - local
    labels:
      com.obsrvr.flow.pipeline: my-pipeline
      com.obsrvr.flow.component: source-component
      com.obsrvr.flow.type: source
      com.obsrvr.flow.local: "true"

  processor_component:
    image: processor-image:latest
    container_name: local-my-pipeline-processor_component
    depends_on:
      - source_component
    restart: unless-stopped
    environment:
      FLOW_COMPONENT_ID: processor-component
      FLOW_COMPONENT_TYPE: processor
      FLOW_PIPELINE_NAME: my-pipeline
      FLOW_LOG_FILE: /var/log/flowctl/my-pipeline/processor_component.log
    volumes:
      - local-logs:/var/log/flowctl/my-pipeline
      - local-data:/flow/data
    networks:
      - local-network
    profiles:
      - local
    labels:
      com.obsrvr.flow.pipeline: my-pipeline
      com.obsrvr.flow.component: processor-component
      com.obsrvr.flow.type: processor
      com.obsrvr.flow.local: "true"

  sink_component:
    image: sink-image:latest
    container_name: local-my-pipeline-sink_component
    depends_on:
      - processor_component
    restart: unless-stopped
    environment:
      FLOW_COMPONENT_ID: sink-component
      FLOW_COMPONENT_TYPE: sink
      FLOW_PIPELINE_NAME: my-pipeline
      FLOW_LOG_FILE: /var/log/flowctl/my-pipeline/sink_component.log
    volumes:
      - local-logs:/var/log/flowctl/my-pipeline
      - local-data:/flow/data
    networks:
      - local-network
    profiles:
      - local
    labels:
      com.obsrvr.flow.pipeline: my-pipeline
      com.obsrvr.flow.component: sink-component
      com.obsrvr.flow.type: sink
      com.obsrvr.flow.local: "true"

networks:
  local-network:
    
volumes:
  local-data:
    labels:
      com.obsrvr.flow.pipeline: my-pipeline
      com.obsrvr.flow.local: "true"
  local-logs:
    labels:
      com.obsrvr.flow.pipeline: my-pipeline
      com.obsrvr.flow.local: "true"
```